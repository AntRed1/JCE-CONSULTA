# ========================================
# CONFIGURACIÓN SPRING BOOT 3.5.0
# Microservicio: JCE Consulta API
# Versión: 1.0.0
# ========================================

# ----------------------------------------
# INFORMACIÓN DE LA APLICACIÓN
# ----------------------------------------
spring.application.name=jce-consulta-ms

# Información para Actuator
info.app.name=JCE Consulta Microservice
info.app.description=Microservicio para consultar información de ciudadanos en el portal JCE de República Dominicana
info.app.version=1.0.0
info.app.developer=A. Rojas
info.app.contact.email=contacto@arojas.dev
info.app.contact.url=https://github.com/arojas/jce-consulta-ms

# ----------------------------------------
# CONFIGURACIÓN DEL SERVIDOR
# ----------------------------------------
server.port=8080
server.servlet.context-path=/api/v1
server.address=0.0.0.0

# Compresión HTTP
server.compression.enabled=true
server.compression.mime-types=application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css
server.compression.min-response-size=1024

# HTTP/2 Support
server.http2.enabled=true

# Graceful shutdown
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=20s

# Configuración Tomcat
server.tomcat.connection-timeout=20s
server.tomcat.keep-alive-timeout=60s
server.tomcat.threads.max=200
server.tomcat.threads.min-spare=20

# ----------------------------------------
# CONFIGURACIÓN JCE PORTAL
# ----------------------------------------
jce.consulta.jce.base-url=${JCE_BASE_URL:https://dataportal.jce.gob.do}
jce.consulta.jce.endpoint=/idcons/IndividualDataHandler.aspx
jce.consulta.jce.default-service-id=${JCE_SERVICE_ID:ca8e51d3-8ddf-47a9-b385-0f0ffa08c65a}
jce.consulta.jce.connection-timeout=10
jce.consulta.jce.read-timeout=25
jce.consulta.jce.user-agent=JCE-Consulta-Microservice/1.0.0
jce.consulta.jce.max-retries=3
jce.consulta.jce.gzip-enabled=true

# ----------------------------------------
# CONFIGURACIÓN WEBCLIENT
# ----------------------------------------
spring.webflux.client.connect-timeout=10000
spring.webflux.client.response-timeout=25000
spring.webflux.client.read-timeout=25000
spring.webflux.client.write-timeout=10000

# Buffer sizes
spring.codec.max-in-memory-size=2MB

# Configuración Reactor Netty
spring.reactor.netty.pool.max-connections=200
spring.reactor.netty.pool.max-idle-time=20s
spring.reactor.netty.pool.max-life-time=60s

# ----------------------------------------
# CONFIGURACIÓN CACHÉ REDIS
# ----------------------------------------
spring.cache.type=redis
spring.cache.redis.time-to-live=300000
spring.cache.redis.cache-null-values=false
spring.cache.cache-names=consultas-jce,rate-limit-buckets

# Redis Connection
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.database=${REDIS_DB:0}
spring.data.redis.timeout=2000ms
spring.data.redis.ssl=${REDIS_SSL:false}

# Redis Connection Pool
spring.data.redis.lettuce.pool.max-active=20
spring.data.redis.lettuce.pool.max-idle=10
spring.data.redis.lettuce.pool.min-idle=5
spring.data.redis.lettuce.pool.max-wait=3000ms

# Configuración de caché personalizada
jce.consulta.cache.default-ttl-minutes=60
jce.consulta.cache.max-size=10000
jce.consulta.cache.distributed-enabled=true
jce.consulta.cache.redis-key-prefix=jce:cache
jce.consulta.cache.local-enabled=true
jce.consulta.cache.stats-enabled=true

# ----------------------------------------
# CONFIGURACIÓN RATE LIMITING
# ----------------------------------------
bucket4j.enabled=true
bucket4j.filters[0].cache-name=rate-limit-buckets
bucket4j.filters[0].url=.*
bucket4j.filters[0].strategy=first
bucket4j.filters[0].http-response-body={ "error": "Límite de solicitudes excedido", "message": "Has superado el límite de solicitudes. Intenta nuevamente más tarde.", "code": "RATE_LIMIT_EXCEEDED", "timestamp": "%s" }
bucket4j.filters[0].rate-limits[0].expression=getRemoteAddr()
bucket4j.filters[0].rate-limits[0].bandwidths[0].capacity=100
bucket4j.filters[0].rate-limits[0].bandwidths[0].time=1
bucket4j.filters[0].rate-limits[0].bandwidths[0].unit=minutes
bucket4j.filters[0].rate-limits[0].bandwidths[0].refill-speed=interval

# Configuración personalizada de rate limiting
jce.consulta.rate-limit.requests-per-window=100
jce.consulta.rate-limit.window-size-minutes=1
jce.consulta.rate-limit.distributed-enabled=true
jce.consulta.rate-limit.redis-key-prefix=jce:ratelimit
jce.consulta.rate-limit.per-ip-enabled=true
jce.consulta.rate-limit.global-enabled=true

# ----------------------------------------
# CONFIGURACIÓN DE RESILENCIA
# ----------------------------------------
jce.consulta.resilience.operation-timeout-seconds=45
jce.consulta.resilience.circuit-breaker-enabled=true
jce.consulta.resilience.circuit-breaker-failure-threshold=5
jce.consulta.resilience.circuit-breaker-wait-duration-seconds=60
jce.consulta.resilience.circuit-breaker-slow-call-rate-threshold=50

# Retry configuration
jce.consulta.resilience.retry-enabled=true
jce.consulta.resilience.max-retry-attempts=3
jce.consulta.resilience.retry-delay-millis=1000
jce.consulta.resilience.retry-multiplier=2.0

# ----------------------------------------
# CONFIGURACIÓN JACKSON
# ----------------------------------------
spring.jackson.default-property-inclusion=NON_NULL
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.serialization.write-durations-as-timestamps=false
spring.jackson.serialization.indent-output=false
spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.deserialization.fail-on-null-for-primitives=true
spring.jackson.time-zone=America/Santo_Domingo
spring.jackson.mapper.use-annotations=true
spring.jackson.mapper.auto-detect-creators=true
spring.jackson.mapper.auto-detect-fields=true
spring.jackson.mapper.auto-detect-getters=true
spring.jackson.mapper.auto-detect-setters=true

# ----------------------------------------
# CONFIGURACIÓN DE VALIDACIÓN
# ----------------------------------------
spring.mvc.throw-exception-if-no-handler-found=true
spring.web.resources.add-mappings=false
spring.validation.lazy-init=true

# ----------------------------------------
# CONFIGURACIÓN DE LOGGING
# ----------------------------------------
logging.config=classpath:logback-spring.xml
logging.level.root=INFO
logging.level.com.arojas.jce_consulta=DEBUG
logging.level.org.springframework.web=INFO
logging.level.org.springframework.web.reactive.function.client=DEBUG
logging.level.org.springframework.cache=INFO
logging.level.org.springframework.security=WARN
logging.level.reactor.netty=WARN

# Archivo de logs
logging.file.path=logs
logging.file.name=jce-consulta-ms.log

# ----------------------------------------
# CONFIGURACIÓN ACTUATOR
# ----------------------------------------
management.endpoints.web.exposure.include=health,info,metrics,prometheus,caches
management.endpoints.web.base-path=/actuator
management.endpoint.health.show-details=WHEN_AUTHORIZED
management.endpoint.health.show-components=always
management.endpoint.health.probes.enabled=true

# Health indicators
management.health.redis.enabled=true
management.health.diskspace.enabled=true
management.health.ping.enabled=true

# Health groups
management.endpoint.health.group.readiness.include=readinessState,redis,diskSpace
management.endpoint.health.group.liveness.include=livenessState

# Métricas
management.endpoint.metrics.enabled=true
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles.http.server.requests=0.5,0.9,0.95,0.99
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,300ms,500ms,1s

# Configuración personalizada de métricas
jce.consulta.metrics.custom-enabled=true
jce.consulta.metrics.jvm-enabled=true
jce.consulta.metrics.system-enabled=true
jce.consulta.metrics.http-enabled=true
jce.consulta.metrics.cache-enabled=true
jce.consulta.metrics.circuit-breaker-enabled=true
jce.consulta.metrics.name-prefix=jce.consulta
jce.consulta.metrics.common-tags=service=jce-consulta,version=1.0.0
jce.consulta.metrics.publish-interval-seconds=60
jce.consulta.metrics.export-enabled=true

# ----------------------------------------
# CONFIGURACIÓN SWAGGER/OPENAPI
# ----------------------------------------
springdoc.api-docs.path=/api-docs
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.try-it-out-enabled=true
springdoc.swagger-ui.operations-sorter=method
springdoc.swagger-ui.tags-sorter=alpha
springdoc.swagger-ui.filter=true
springdoc.swagger-ui.disable-swagger-default-url=true
springdoc.swagger-ui.use-root-path=true
springdoc.show-actuator=false
springdoc.group-configs[0].group=jce-consulta-api
springdoc.group-configs[0].packages-to-scan=com.arojas.jce_consulta.controller

# ----------------------------------------
# CONFIGURACIÓN DE SEGURIDAD
# ----------------------------------------
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=false
server.servlet.session.cookie.same-site=lax

# Error handling
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=ON_PARAM
server.error.include-exception=false

# ----------------------------------------
# CONFIGURACIÓN DE ENCODING
# ----------------------------------------
spring.mandatory-file-encoding=UTF-8
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true

# ----------------------------------------
# CONFIGURACIÓN DE INTERNACIONALIZACIÓN
# ----------------------------------------
spring.messages.basename=messages
spring.messages.encoding=UTF-8
spring.messages.cache-duration=3600s

# ----------------------------------------
# CONFIGURACIONES ADICIONALES
# ----------------------------------------

# WebFlux base path
spring.webflux.base-path=/
spring.webflux.static-path-pattern=/**

# Async configuration
spring.mvc.async.request-timeout=30s

# ========================================
# VARIABLES DE ENTORNO RECOMENDADAS
# ========================================
#
# Para personalizar la configuración, utiliza estas variables de entorno:
#
# REDIS_HOST=localhost              # Host del servidor Redis
# REDIS_PORT=6379                   # Puerto de Redis
# REDIS_PASSWORD=                   # Contraseña de Redis (vacía por defecto)
# REDIS_DB=0                        # Base de datos Redis
# REDIS_SSL=false                   # Habilitar SSL para Redis
#
# JCE_BASE_URL=https://dataportal.jce.gob.do  # URL base del portal JCE
# JCE_SERVICE_ID=ca8e51d3-8ddf-47a9-b385-0f0ffa08c65a  # Service ID para consultas
#
# ========================================
# NOTAS DE CONFIGURACIÓN
# ========================================
#
# Esta configuración está optimizada para un entorno de desarrollo/producción balanceado
# con las siguientes características:
#
# 1. Rate limiting configurado para 100 requests/minuto por IP
# 2. Cache Redis con TTL de 5 minutos para consultas
# 3. Circuit breaker habilitado con configuración resiliente
# 4. Timeouts balanceados para buena experiencia de usuario
# 5. Métricas completas habilitadas para monitoreo
# 6. Logging optimizado para debug y producción
# 7. Compresión HTTP habilitada para mejor performance
# 8. Health checks configurados para Kubernetes/Docker
#
# Para ajustar según el entorno específico, modifica las variables
# de entorno correspondientes sin necesidad de cambiar este archivo.
#
# ========================================